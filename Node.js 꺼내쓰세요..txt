const express = require('express')
const app = express()

#ì²˜ìŒ ì‹œì‘

app.use(express.static(__dirname + '/public'))
#CSS ì‚¬ìš©


npm install ejs

app.set('view engine', 'ejs')
#ejs ì„¸íŒ…


1.app.use(express.json())
#jsoníŒŒì¼ì„ íŒŒì‹±(parse)

2.app.use(express.urlencoded({extended:true})) 
#ëª°ë¼ ê± ì¨
#ìœ ì € ë°ì´í„° êº¼ë‚´ì“°ëŠ” ì½”ë“œì„

#req.body ì“¸ ë•Œ ì“°ëŠ” ì½”ë“œì„


const { MongoClient } = require('mongodb')

let db
const url = 'mongodbì‚¬ì´íŠ¸ì— ìˆë˜ ë‹˜ë“¤ì˜ DB ì ‘ì† URL'
new MongoClient(url).connect().then((client)=>{
  console.log('DBì—°ê²°ì„±ê³µ')
  db = client.db('DB ì´ë¦„')
}).catch((err)=>{
  console.log(err)
})
#mongoDB ì—°ê²°


res.sendFile(__dirname + "/index.html");
#html ë„ìš°ê¸° (ejsëŠ” render)

async - await db.collection('ì»¬ë ‰ì…˜ ì´ë¦„').find().toArray();
#awaitì€ ì´ ì½”ë“œê°€ ì‹¤í–‰ë  ë•Œê¹Œì§€ ë‹¤ë¥¸ ê±° í•˜ì§€ ë§ê³  ê¸°ë‹¤ë ¤ë¼.
#ì»¬ë ‰ì…˜ì—ì„œ ë°ì´í„° êº¼ë‚´ê¸° Arrayë¡œ ë½‘ì•„ë¼.


await db.collection('ì»¬ë ‰ì…˜ ì´ë¦„').insertOne({title: req.body.title, content: req.body.content});
#DBì— ë„£ë„ë¡ í•˜ì—¬ë¼.


.redirect('/íŒŒì¼ ì´ë¦„') 
#ì €ê¸°ë¡œ ì´ë™í•˜ì—¬ë¼.




await db.collection('post').updateOne({_id: new ObjectId (req.params.skrr)},{$set:{title: req.body.title, content: req.body.content}});
#ìˆ˜ì •í•˜ì—¬ë¼
#$set == ë®ì–´ì“°ê¸°
#$mul == ê³±í•˜ê¸°
#$inc == ì¦ê°€
#$unset == í•„ë“œê°’ ì‚­ì œ
#$gt == ì´ˆê³¼
#$gte == ì´ìƒ
#$lt == ë¯¸ë§Œ
#$lte == ì´í•˜
#$ne == ì•„ë‹Œ ê°’ë§Œ

#updateMany == ì¡°ê±´ì— ë§ëŠ” ëª¨ë“  ê²ƒí•œí…Œ ìˆ˜ì •í•œë‹¤
#ì˜ˆë¥¼ ë“¤ì–´ like í•­ëª©ì´ 10 ì´ìƒì¸ documentë¥¼ ì „ë¶€ ìˆ˜ì •í•˜ê³  ì‹¶ë‹¤ë©´
updateMany({like : {$gt : 10}}
#ì´ëŸ° ì‹ìœ¼ë¡œ ì¡°ê±´ì„ ì¤€ë‹¤ gtëŠ” greater thanì´ë‹¤




const methodOverride = require('method-override')
app.use(methodOverride('_method'))
#ejsì—ì„œ putìœ¼ë¡œ ë°›ê¸°
#ejsì—ì„œ form action ì£¼ì†Œ ë’¤ì— ?_method=PUTì„ ë¶™ì´ê³ 
#ë°±ì—”ë“œ APIë¥¼ PUTìœ¼ë¡œ ìˆ˜ì •
#deleteë„ ã„±ã„´






npm install sequelize sequelize-cli mysql2
#db ì‘ì—…ì„ ì‰½ê²Œ í•´ì£¼ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ì¸ sequelize ì„¤ì¹˜



sequelize init
#ì´ˆê¸°í™” ëª…ë ¹ì–´

config == db ì„¤ì • íŒŒì¼
mirgrations == gitì²˜ëŸ¼ dbê°€ ë³€í™”í•˜ëŠ” ê³¼ì •ë“¤ì„ ì¶”ì í•¨ ë³€í™”ë¥¼ ì·¨ì†Œí•˜ê±°ë‚˜ dbì— ë°˜ì˜ ã„±ã„´
models == db ê° í…Œì´ë¸”ì˜ ì •ë³´ ë° í•„ë“œ íƒ€ì… ì •ì˜
seeders == í…Œì´ë¸”ì— ê¸°ë³¸ ë°ì´í„°ë¥¼ ë„£ê³  ì‹¶ì„ ë•Œ


require("dotenv".config());
 npm i dotenv
#.envì—ì„œ êº¼ë‚´ì„œ ì“°ë ¤ë©´ dontev

ajax == ìƒˆë¡œê³ ì¹¨ ì—†ì´ ì„œë²„ë¡œ ìš”ì²­ ê°€ëŠ¥
#ex. form, a, ì£¼ì†Œì°½.. ë“±ë“±ì€ ìƒˆë¡œê³ ì¹¨ ë¨
#ajaxì˜ ì¥ì ì€ ìƒˆë¡œê³ ì¹¨ì´ ì—†ëŠ” ê²ƒì´ê¸° ë•Œë¬¸ì— redirect, render ê¸ˆì§€.

document.querySelectorAll('.delete')[0]
.addEventListener('click', function(){
    fetch('/abc', {
        method : 'POST',
        headers : {
            'Content-Type' : 'application/json'
        },
        body : JSON.stringify({a:1})
    })
})
#



document.querySelectorAll('.delete')[0]
.addEventListener('click', function(){
    fetch('/abc?age=20')
    // querystringìœ¼ë¡œ ì„œë²„ì— ë³´ë‚´ê¸° ìš”ì²­.query ì—¬ëŸ¬ê°œ ë³´ë‚¼ ë•ŒëŠ” & ì‚¬ìš©

})





<button class="delete" data-id="<%=posts[i]._id%>">ğŸ‘¹</button>
#data-idì— ì €ê²ƒì„ ë„£ì–´ë¼


    let deletes = document.querySelectorAll('.delete');
    for(let i=0; i<deletes.length;i++){
        deletes[i].addEventListener('click', function(e){
        fetch('/delete?docid=' + e.target.dataset.id, {
            method : 'DELETE',
        }).then((r)=>r.text())
        .then((r)=>{console.log(r)})
    })
}
#data idì—ì„œ ê°€ì ¸ì™€ì„œ req.queryë¡œ ë¿Œë ¤ë¼
#res.sendë¥¼ ë¿Œë ¤ë¼ rì— ë‹´ì•„ì„œ í…ìŠ¤íŠ¸ë¡œ



#ì. ì§€ê¸ˆì¯¤ ê°œê¸¸ì–´ì„œ ë¹¡ì¹œ ë°•íƒœí™˜ì´ë©´ ê°œì¶”.
#ê·¸ë˜ì„œ ìˆëŠ” ê²Œ ë°”ë¡œ axiosì„.
axios.get() <- ì´ê±° ìŒ‰ê°€ëŠ¥. êµ¬ê¸€ì— ê²€ìƒ‰ ã„±ã„±


app.get('/list/:id', async(req,res)=>{
    let result = await db.collection('post')
    .find().skip((req.params.id -1)*5)
    .limit(5).toArray()
    res.render('list.ejs', {posts:result})
})
// skipìœ¼ë¡œ ê±´ë„ˆë›°ì–´ë¼
// skip ì•ˆì— í•˜ë“œì½”ë”©ìœ¼ë¡œ ìˆ«ìë¥¼ ë„£ì„ ìˆ˜ ìˆìœ¼ë‚˜ ë„ˆë¬´ ìˆ˜ê°€ í¬ë©´ ê³¼ë¶€í•˜ ì˜´
// 1í˜ì´ì§€, 2í˜ì´ì§€ ì´ëŸ° ê¸°ëŠ¥ì— ì‚¬ìš©



// app.get('/list/next/:id', async(req,res)=>{
//     let result = await db.collection('post')
//     .find({_id: {$gt:  new ObjectId(req.params.id)}}) //ë°©ê¸ˆ ë³¸ ë§ˆì§€ë§‰ ê²Œì‹œë¬¼_id
//     .limit(5).toArray()
//     res.render('list.ejs', {posts:result})
// })

// ë°‘ì—ì„œ ë”ë³´ê¸° í´ë¦­í•´ì„œ ë¦¬ìŠ¤íŠ¸ ë” ê°€ì ¸ì˜¬ ë•Œ ì‚¬ìš©. ê°œë¹ ë¥´ë‹¤ëŠ” ê²Œ ì¥ì .
// í—ˆë‚˜ í˜ì´ì§€ë„¤ì´ì…˜ ëª» í•˜ê³  í˜„ì¬ í˜ì´ì§€ì—ì„œë§Œ




#ë¡œê·¸ì¸/íšŒì›ê°€ì…
#sessionê³¼ tokenì´ ìˆìŒ


#sessionì€ session idë§Œ ë°›ìŒ
#session idë¥¼ ìœ ì €ê°€ ì œì¶œí•˜ë©´ idê°€ ë§ëŠ” document dbì—ì„œ ì°¾ê³  ë§ìœ¼ë©´ í†µê³¼
#ì¥ì : ìš”ì²­ë§ˆë‹¤ ì²´í¬í•´ì„œ ì—„ê²©í•¨
#ë‹¨ì : í•˜ë„ ë§ì´ ì²´í¬í•´ì„œ db í˜ë“¤ì–´í•¨

#token(JWT)ëŠ” dbì— ì €ì¥í•˜ì§€ ì•Šê³  ì•„ì´ë””, ë¡œê·¸ì¸ë‚ ì§œ ë“±ë“± ì•”í˜¸í™”í•´ì„œ ë³´ëƒ„
#ì„œë²„ê°€ í™•ì¸ í›„ í†µê³¼
#ì•”í˜¸í™”í•˜ê¸° ë•Œë¬¸ì— ìœ„ì¡° ê±±ì • ã„´
#dbê°€ í˜ë“¤ì§€ ì•ŠìŒ
#ì¥ì : ìœ ì € ë§ìœ¼ë©´ ê°œê¿€
#ë‹¨ì : ì…ì¥ê¶Œ ëºê¸°ë©´ ë§‰ì„ ë°©ë²• ì—†ìŒ

#OAuth
#A ì‚¬ì´íŠ¸ ì •ë³´ ê°€ì ¸ì™€ì„œ B ì‚¬ì´íŠ¸ì—ì„œ í™œìš© ex.ì†Œì…œ ë¡œê·¸ì¸


npm i express-session passport passport-local
#passport = íšŒì› ì¸ì¦ ë„ì™€ì£¼ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬
#passport-local = ì•„ì´ë””-ë¹„ë²ˆ ë°©ì‹ìœ¼ë¡œ íšŒì› ì¸ì¦ í•  ë•Œ 
#express-session = session ë§Œë“œëŠ” ê±° ë„ì™€ì£¼ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬

const session = require('express-session');
const passport = require('passport');
const LocalStrategy = require('passport-local');

app.use(passport.initialize());
app.use(session({
    secret: 'ì•”í˜¸í™” ë¹„ë²ˆ', //ì•”í˜¸í™” í•  ë•Œ ì“¸ ë¹„ë²ˆ
    resave: false, //ìš”ì²­í•  ë•Œë§ˆë‹¤ ê°±ì‹ í•  ê±´ì§€
    saveUninitialized : false //ë¡œê·¸ì¸ ì•ˆ í•´ë„ ì„¸ì…˜ ë§Œë“¤ ê±´ì§€
    cookie: {maxAge:60 * 60 * 1000} //ë°€ë¦¬ì„¸ì»¨ë“œ. 1ì´ˆê°€ 1000
    store : MongoStore.create({
        mongoUrl : 'mongodb+srv://dcpop28201004_db_user:dc-28201004@cluster0.gyfb2fh.mongodb.net/?appName=Cluster0',
        dbName : 'forum',
    })
}))
app.use(passport.session())

#ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ìš© ê¸°ë³¸ ë¬¸êµ¬ (ìˆœì„œ ì¡°ì‹¬)


                                #ì‚¬ìš©ìê°€ ì…ë ¥í•œ id, pw. cbëŠ” ì„±ê³µ/ì‹¤íŒ¨/ì—ëŸ¬ë¥¼ passportì—ê²Œ ì•Œë ¤ì£¼ëŠ” í•¨ìˆ˜
passport.use(new LocalStrategy(async (id, pw, cb) => {
    let result = await db.collection('user').findOne({username: id})
    if(!result){
        return cb(null, false, {message : 'ì•„ì´ë”” dbì— ì—†ìŒ'})
    }                   #íšŒì›ì¸ì¦ ì‹¤íŒ¨ ì‹œ false ì¨ì•¼ ë°

    if(await bcrypt.compare(pw, result.password)){
        return cb(null, result)
    }else{
        return cb(null, false, {message: 'ë¹„ë²ˆ ë¶ˆì¼ì¹˜'});
    }
}))

// ì•„ì´ë””/ ë¹„ë²ˆì´ dbì™€ ì¼ì¹˜í•˜ëŠ”ê°€?
// passport.authenticate('local')ë¡œ ì´ ê¸°ëŠ¥ì„ ì‹¤í–‰ì‹œí‚¬ ìˆ˜ ìˆìŒ
// ì•„ì´ë”” ë¹„ë²ˆì´ dbì™€ ë‹¤ë¥´ë©´ falseë¥¼ cb() ì•ˆì— ë„£ìŒ
#await bcrypt.compare(pw, result.password) í•´ì‹±ëœ ë¹„ë²ˆ ëŒ€ì¡°


#ë²ˆì™¸
passReqToCallback
#ì•„ì´ë”” ë¹„ë²ˆ ì™¸ì— ìœ ì €ê°€ ì œì¶œí•œ ë‹¤ë¥¸ ê²ƒë„ ê²€ì‚¬ í•˜ëŠ” 


app.post('/login', async(req,res, next)=>{
    passport.authenticate('local', (error, user, info)=>{
        if(error) return res.status(500).json(error)
        if(!user) return res.status(401).json((info.message))
        req.logIn(user, (err)=>{
            if(err) return next(err)
            res.redirect('/')
            })
    })(req,res,next)
})
#error ì‹¤íŒ¨ ì‹œ ì—ëŸ¬ ì½”ë“œ
#user ì„±ê³µ ì‹œ ìœ ì € ì •ë³´
#info ì‹¤íŒ¨ ì‹œ ì´ìœ 
#next()ëŠ” ë‹¤ìŒ ë¯¸ë“¤ì›¨ì–´ë¡œ ë„˜ì–´ê°
//ë¡œê·¸ì¸ ì„±ê³µì¸ì§€ ì‹¤íŒ¨ì¸ì§€
// req.logInì´ ì‹¤í–‰ë˜ë©´ ìë™ìœ¼ë¡œ ë°‘ì— serialize ì‹¤í–‰


passport.serializeUser((user,done) =>{
    process.nextTick(() =>{
        done(null, {id:user._id,username: user.username})
    })
})
// doneì— ë“¤ì–´ê°„ ì •ë³´ê°€ ì„¸ì…˜ì— ê¸°ë¡ë¨
// ì¿ í‚¤ ìœ ì €ì—ê²Œ ë³´ë‚´ì£¼ê¸°
// ë¡œê·¸ì¸ ì‹œ ì„¸ì…˜ ë§Œë“œëŠ” ì½”ë“œ
// userì—ëŠ” ìœ„ì— ì½”ë“œì—ì„œ ì…ë ¥í•œ ì •ë³´ê°€ ë“¤ì–´ìˆìŒ
// process.next ì–´ì©Œêµ¬ëŠ” ë¹„ë™ê¸° ì²˜ë¦¬í•˜ëŠ” í•¨ìˆ˜

passport.deserializeUser(async(user, done) =>{
    let result = await db.collection('user').findOne({_id: new ObjectId(user.id)})
    delete result.password
    process.nextTick(() => {
        done(null, result)
    })
})
// ì¿ í‚¤ ë¶„ì„í•˜ëŠ” ê¸°ëŠ¥
// ì¿ í‚¤ ì´ìƒ ì—†ìœ¼ë©´ ìœ ì € ì •ë³´ ì•Œë ¤ì¤Œ
// ì¿ í‚¤ ì´ìƒ ì—†ìœ¼ë©´ ëª¨ë“  apië“¤ì—ì„œ req.userí•˜ë©´ íšŒì› ì •ë³´ ë¿… ë‚˜ì˜´
//ìµœì‹  ì •ë³´ë¥¼ ê°–ê³  ì˜¤ê¸° ìœ„í•´ dbì—ì„œ ê°€ì ¸ì˜´
//ë‘˜ì§¸ íŒŒë¼ë¯¸í„°ì— ì‡½ í•˜ë©´ ìë™ìœ¼ë¡œ user ì•ˆì— ë¿… ë“¤ì–´ê°



await bcrypt.hash(req.body.password, 10)
#ë¹„ë²ˆ í•´ì‰¬í•˜ê¸°. ì˜¤ë¥¸ìª½ ìˆ«ìëŠ” ëª‡ ë²ˆ ê¼¬ì„ ê±´ì§€.
#í•´í‚¹ì„ ë§‰ê¸° ìœ„í•´ saltë¥¼ í•˜ëŠ”ë°, dbì— ì €ì¥í•˜ê¸° ì‹«ê³  ë‹¤ë¥¸ ì•ˆì „í•œ ê³³ì— ë³´ê´€í•˜ë ¤ë©´ pepper
